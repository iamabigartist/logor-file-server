name: Publish Build Artifacts

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: "Build configuration"
        required: false
        type: choice
        options:
          - Release
          - Debug
        default: "Release"
      release_name:
        description: "Release name/tag (optional)"
        required: false
        type: string

env:
  DOTNET_VERSION: "8.0.x"

jobs:
  build-and-publish:
    name: Build and Publish Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build for all platforms
        id: build
        run: |
          echo "ğŸ—ï¸ Building for all platforms..."
          node devops/build-api-all-platforms.js --configuration ${{ inputs.configuration }}

          # Extract the build directory name from the build script output
          BUILD_DIR=$(find publish -name "build-*" -type d | head -1)
          BUILD_DIR_NAME=$(basename "$BUILD_DIR")
          echo "build_directory=$BUILD_DIR_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“ Build directory: $BUILD_DIR_NAME"

      - name: List build contents
        run: |
          BUILD_DIR="publish/${{ steps.build.outputs.build_directory }}"
          echo "ğŸ“ Build directory contents:"
          ls -la "$BUILD_DIR"
          echo ""
          echo "ğŸ“Š Platform directories:"
          find "$BUILD_DIR" -maxdepth 1 -type d | tail -n +2

      - name: Create single artifact
        run: |
          BUILD_DIR="publish/${{ steps.build.outputs.build_directory }}"
          ARTIFACT_NAME="${{ steps.build.outputs.build_directory }}"

          echo "ğŸ“¦ Creating single artifact: $ARTIFACT_NAME.zip"

          # Create zip archive of the entire build directory
          cd "$BUILD_DIR"
          zip -r "${{ github.workspace }}/$ARTIFACT_NAME.zip" ./*
          cd "${{ github.workspace }}"

          echo "âœ… Created artifact: $ARTIFACT_NAME.zip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.build_directory }}
          path: ${{ github.workspace }}/${{ steps.build.outputs.build_directory }}.zip
          retention-days: 30

      - name: Show artifact summary
        run: |
          echo "ğŸ‰ Build and publish completed successfully!"
          echo "ğŸ—ï¸  Build configuration: ${{ inputs.configuration }}"
          echo "ğŸ“ Build directory: ${{ steps.build.outputs.build_directory }}"
          echo "ğŸ“¦ Single artifact created: ${{ steps.build.outputs.build_directory }}.zip"
          echo "ğŸ“¥ Available for download in workflow run artifacts"

          if [ -n "${{ inputs.release_name }}" ]; then
            echo "ğŸ·ï¸  Release name: ${{ inputs.release_name }}"
          fi
