name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Semantic version bump level"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Release
          - Debug

env:
  DOTNET_VERSION: "9.0.x"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # For creating releases and tags

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git history and tags

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Bump version and create tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ inputs.bump }}
          release_branches: main

      - name: Build for all platforms
        run: |
          echo "üèóÔ∏è Building for all platforms..."
          node devops/build-api-all-platforms.js --configuration ${{ inputs.configuration }}

      - name: Get build directory
        id: get_build_dir
        run: |
          BUILD_DIR=$(find publish -name "build-*" -type d | head -1)
          BUILD_DIR_NAME=$(basename "$BUILD_DIR")
          echo "build_directory=$BUILD_DIR_NAME" >> $GITHUB_OUTPUT
          echo "üìÅ Build directory: $BUILD_DIR_NAME"

      - name: Create platform-specific archives
        run: |
          BUILD_DIR="publish/${{ steps.get_build_dir.outputs.build_directory }}"
          VERSION="${{ steps.tag_version.outputs.new_tag }}"

          echo "üì¶ Creating platform-specific archives..."

          # Create archives for each platform
          for platform_dir in "$BUILD_DIR"/*/; do
            if [ -d "$platform_dir" ]; then
              platform=$(basename "$platform_dir")
              archive_name="LogorFileServer-$VERSION-$platform"
              
              echo "üì¶ Creating $archive_name.zip"
              cd "$platform_dir"
              zip -r "${{ github.workspace }}/$archive_name.zip" ./*
              cd "${{ github.workspace }}"
              
              echo "‚úÖ Created: $archive_name.zip"
            fi
          done

      - name: Create single multi-platform archive
        run: |
          BUILD_DIR="publish/${{ steps.get_build_dir.outputs.build_directory }}"
          VERSION="${{ steps.tag_version.outputs.new_tag }}"
          ARCHIVE_NAME="LogorFileServer-$VERSION-all-platforms"

          echo "üì¶ Creating multi-platform archive: $ARCHIVE_NAME.zip"

          # Create zip archive of the entire build directory
          cd "$BUILD_DIR"
          zip -r "${{ github.workspace }}/$ARCHIVE_NAME.zip" ./*
          cd "${{ github.workspace }}"

          echo "‚úÖ Created: $ARCHIVE_NAME.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: LogorFileServer ${{ steps.tag_version.outputs.new_tag }}
          body: |
            # LogorFileServer ${{ steps.tag_version.outputs.new_tag }}

            ## Release Notes

            - Built for multiple platforms: Windows, Linux, and macOS
            - Configuration: ${{ inputs.configuration }}
            - Version bump: ${{ inputs.bump }}

            ## Downloads

            - **All Platforms**: LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-all-platforms.zip
            - **Windows x64**: LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-win-x64.zip
            - **Linux x64**: LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-linux-x64.zip
            - **macOS x64**: LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-osx-x64.zip

            ## Usage

            Extract the archive for your platform and run the executable:
            - Windows: `LogorFileServer.Api.exe`
            - Linux/macOS: `./LogorFileServer.Api`
          files: |
            LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-all-platforms.zip
            LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-win-x64.zip
            LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-linux-x64.zip
            LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-osx-x64.zip

      - name: Show release summary
        run: |
          echo "üéâ Release created successfully!"
          echo "üè∑Ô∏è  Version: ${{ steps.tag_version.outputs.new_tag }}"
          echo "üì¶ Build configuration: ${{ inputs.configuration }}"
          echo "üîÑ Version bump: ${{ inputs.bump }}"
          echo "üìÅ Build directory: ${{ steps.get_build_dir.outputs.build_directory }}"
          echo "üì• Release available at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_version.outputs.new_tag }}"
