name: Release

run-name: "Release #${{ github.run_number }} (${{ inputs.bump }}) ${{inputs.dispatch_id}}"

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Semantic version bump level"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      configuration:
        description: "Build configuration"
        required: false
        default: "Release"
        type: choice
        options:
          - Release
          - Debug
      dispatch_id:
        description: "Unique ID for this dispatch (used for tracking)"
        required: false
        default: "default"
        type: string

env:
  DOTNET_VERSION: "9.0.x"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # For creating releases and tags

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git history and tags

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Bump version and create tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: ${{ inputs.bump }}
          release_branches: main

      - name: Build for all platforms
        run: |
          echo "ğŸ—ï¸ Building for all platforms..."
          node devops/build-api-all-platforms.js --configuration ${{ inputs.configuration }}

      - name: Get build directory
        id: get_build_dir
        run: |
          BUILD_DIR=$(find publish -name "build-*" -type d | head -1)
          BUILD_DIR_NAME=$(basename "$BUILD_DIR")
          echo "build_directory=$BUILD_DIR_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“ Build directory: $BUILD_DIR_NAME"

      - name: Create single multi-platform archive
        run: |
          BUILD_DIR="publish/${{ steps.get_build_dir.outputs.build_directory }}"
          VERSION="${{ steps.tag_version.outputs.new_tag }}"
          ARCHIVE_NAME="LogorFileServer-$VERSION-all-platforms"

          echo "ğŸ“¦ Creating multi-platform archive: $ARCHIVE_NAME.zip"

          # Create zip archive of the entire build directory
          cd "$BUILD_DIR"
          zip -r "${{ github.workspace }}/$ARCHIVE_NAME.zip" ./*
          cd "${{ github.workspace }}"

          echo "âœ… Created: $ARCHIVE_NAME.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: LogorFileServer ${{ steps.tag_version.outputs.new_tag }}
          body: |
            # LogorFileServer ${{ steps.tag_version.outputs.new_tag }}

            ## Release Notes

            - Built for multiple platforms: Windows, Linux, and macOS
            - Configuration: ${{ inputs.configuration }}
            - Version bump: ${{ inputs.bump }}

            ## Downloads

            - **All Platforms**: LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-all-platforms.zip

            ## Usage

            Extract the all-platforms archive, navigate to the folder for your platform, and run the executable:
            - Windows: `LogorFileServer.Api.exe`
            - Linux/macOS: `./LogorFileServer.Api`
          files: |
            LogorFileServer-${{ steps.tag_version.outputs.new_tag }}-all-platforms.zip

      - name: Show release summary
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ·ï¸  Version: ${{ steps.tag_version.outputs.new_tag }}"
          echo "ğŸ“¦ Build configuration: ${{ inputs.configuration }}"
          echo "ğŸ”„ Version bump: ${{ inputs.bump }}"
          echo "ğŸ“ Build directory: ${{ steps.get_build_dir.outputs.build_directory }}"
          echo "ğŸ“¥ Release available at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag_version.outputs.new_tag }}"
